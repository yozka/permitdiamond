#include "pdOptions.h"
#include <EEPROM.h>
///--------------------------------------------------------------------------------------



using namespace Options;
///--------------------------------------------------------------------------------------





///=====================================================================================
///
/// Constructor
/// 
/// 
///--------------------------------------------------------------------------------------
AOptions::AOptions()
{

}
///--------------------------------------------------------------------------------------





///=====================================================================================
///
/// Destructor
/// 
/// 
///--------------------------------------------------------------------------------------
AOptions::~AOptions()
{

}
///--------------------------------------------------------------------------------------





 ///=====================================================================================
///
/// установим данные по умолчанию
/// 
/// 
///--------------------------------------------------------------------------------------
void AOptions::defaultData(TData &data) const
{
	memset(&data, 0, sizeof(TData));

	data.crc = CRCKey;


	String name = FPSTR("Diamond");
	name.getBytes(data.name, sizeof(TData::name));
}
///--------------------------------------------------------------------------------------








 ///=====================================================================================
///
/// вернуть настройки по умолчанию
/// 
/// 
///--------------------------------------------------------------------------------------
void AOptions :: reinitialize()
{
	TData data;
	defaultData(data);
	write(data);
}
///--------------------------------------------------------------------------------------






 ///=====================================================================================
///
/// имя точки доступа
/// 
/// 
///--------------------------------------------------------------------------------------
String AOptions :: ssid() const
{
	TData data;
	read(data);
	return (char*)data.ssid;
}
///--------------------------------------------------------------------------------------



 ///=====================================================================================
///
/// пароль точки доступа
/// 
/// 
///--------------------------------------------------------------------------------------
String AOptions :: password() const
{
	TData data;
	read(data);
	return (char*)data.password;
}
///--------------------------------------------------------------------------------------









 ///=====================================================================================
///
/// установка индификатора точки доступа
/// 
/// 
///--------------------------------------------------------------------------------------
void AOptions :: setSsid(const String &ssid)
{
	TData data;
	read(data);
	ssid.getBytes(data.ssid, sizeof(TData::ssid));
	write(data);
}
///--------------------------------------------------------------------------------------





 ///=====================================================================================
///
/// устновка пароля
/// 
/// 
///--------------------------------------------------------------------------------------
void AOptions :: setPassword (const String &password)
{
	TData data;
	read(data);
	password.getBytes(data.password, sizeof(TData::password));
	write(data);
}
///--------------------------------------------------------------------------------------







 ///=====================================================================================
///
/// возвратить имя устройства
/// 
/// 
///--------------------------------------------------------------------------------------
String AOptions :: name()const
{
	TData data;
	read(data);
	return (char*)data.name;
}
///--------------------------------------------------------------------------------------







 ///=====================================================================================
///
/// утсновка иммя устройства
/// 
/// 
///--------------------------------------------------------------------------------------
void AOptions :: setName(const String &name)
{
	TData data;
	read(data);
	name.getBytes(data.name, sizeof(TData::name));
	write(data);
}
///--------------------------------------------------------------------------------------






 ///=====================================================================================
///
/// чтение данных
/// 
/// 
///--------------------------------------------------------------------------------------
void AOptions :: read(TData &data) const
{
	EEPROM.begin(sizeof(TData));
	EEPROM.get(0, data);
	EEPROM.end();
	if (data.crc != CRCKey)
	{
		defaultData(data);
	}
}
///--------------------------------------------------------------------------------------





 ///=====================================================================================
///
/// запись данных
/// 
/// 
///--------------------------------------------------------------------------------------
void AOptions :: write(const TData &data)
{
	EEPROM.begin(sizeof(TData));
	EEPROM.put(0, data);
	EEPROM.end();
}
///--------------------------------------------------------------------------------------



